-----

# Глава 14: Первый GTK-проект — Окно с кнопкой

В этой главе мы создадим простейшее полноценное приложение с использованием библиотеки **GTK** — окно с кнопкой **«Закрыть»**, при нажатии на которую программа завершает работу.

Это ваш первый практический шаг в создании интерактивных GUI-приложений с использованием **GTK** и языка **C** на **Raspberry Pi Zero 2 W** (или любой другой системе с установленной GTK3).

### Основные цели этой главы:

  * **Понять базовую структуру** минимального GTK-приложения.
  * **Создать основное окно** приложения.
  * **Добавить интерактивный элемент** — кнопку — в окно.
  * **Обработать событие** нажатия на кнопку для завершения работы программы.
  * **Скомпилировать и запустить** ваше первое GUI-приложение.

-----

## Пример кода: Окно с кнопкой "Закрыть"

Название исходного файла: `minimal_window.c`

В этом примере мы создадим окно, добавим в него кнопку и научим кнопку закрывать приложение при нажатии.

```c
#include <gtk/gtk.h> // Подключаем основную библиотеку GTK. Этого заголовочного файла достаточно для большинства базовых функций.

/**
 * @brief Callback-функция, которая будет вызвана при нажатии кнопки.
 *
 * Эта функция закрывает окно приложения. Она подключается к сигналу "clicked"
 * кнопки и получает указатель на окно в качестве пользовательских данных.
 *
 * @param widget Указатель на GtkWidget, который испустил сигнал (в данном случае, кнопка).
 * @param data   Указатель на пользовательские данные, переданные при подключении сигнала.
 * В нашем примере это будет указатель на GtkWindow, которое нужно закрыть.
 */
static void on_button_clicked(GtkWidget *widget, gpointer data) {
    // Закрываем окно, переданное в качестве 'data'.
    // GTK_WINDOW(data) - это макрос приведения типа (type casting), который безопасно
    // преобразует универсальный указатель gpointer к более специфичному типу GtkWindow*.
    // Это необходимо, так как функция gtk_window_close() ожидает аргумент типа GtkWindow*.
    gtk_window_close(GTK_WINDOW(data));
}

/**
 * @brief Главная функция программы.
 *
 * Здесь происходит инициализация GTK, создание окна, кнопки,
 * подключение сигналов и запуск основного цикла событий GTK.
 *
 * @param argc Количество аргументов командной строки.
 * @param argv Массив строк аргументов командной строки.
 * @return Код завершения программы (0 при успешном выполнении).
 */
int main(int argc, char *argv[]) {
    // Инициализируем библиотеку GTK.
    // Это обязательный вызов для любой GTK-программы. Он обрабатывает аргументы
    // командной строки, специфичные для GTK, и подготавливает внутренние структуры
    // библиотеки для работы. Должен быть вызван до создания любых виджетов GTK.
    gtk_init(&argc, &argv);

    // Создаём новое окно верхнего уровня.
    // GtkWidget* - это базовый тип для всех видимых элементов (виджетов) в GTK.
    // GTK_WINDOW_TOPLEVEL указывает, что это будет независимое, главное окно приложения.
    GtkWidget *window = gtk_window_new(GTK_WINDOW_TOPLEVEL);

    // Устанавливаем заголовок окна. Этот текст будет отображаться в строке заголовка окна.
    // GTK_WINDOW(window) выполняет приведение типа, поскольку gtk_window_set_title()
    // ожидает аргумент типа GtkWindow*.
    gtk_window_set_title(GTK_WINDOW(window), "GTK Minimal App");

    // Устанавливаем размер окна по умолчанию (ширина, высота) в пикселях.
    // Эти размеры могут быть изменены пользователем.
    gtk_window_set_default_size(GTK_WINDOW(window), 300, 100);

    // Устанавливаем начальное положение окна на экране.
    // GTK_WIN_POS_CENTER центрирует окно на экране при его первом появлении.
    gtk_window_set_position(GTK_WINDOW(window), GTK_WIN_POS_CENTER);

    // Подключаем сигнал "destroy" окна к функции gtk_main_quit.
    // Сигнал "destroy" испускается, когда пользователь пытается закрыть окно
    // (например, кликая на кнопку "X" в заголовке окна или используя Alt+F4).
    // gtk_main_quit() - это встроенная функция GTK, которая останавливает
    // главный цикл событий GTK, позволяя программе корректно завершиться.
    // Если этого не сделать, закрытие окна не остановит программу, и она будет висеть в памяти.
    g_signal_connect(window, "destroy", G_CALLBACK(gtk_main_quit), NULL);

    // Создаём новую кнопку с текстовой меткой "Закрыть".
    GtkWidget *button = gtk_button_new_with_label("Закрыть");

    // Подключаем сигнал "clicked" от нашей кнопки к функции on_button_clicked.
    // Когда пользователь нажимает на эту кнопку, GTK вызовет функцию on_button_clicked.
    // В качестве четвёртого аргумента (user_data) мы передаём указатель на 'window'.
    // Это позволяет функции on_button_clicked получить доступ к окну, которое нужно закрыть.
    g_signal_connect(button, "clicked", G_CALLBACK(on_button_clicked), window);

    // Добавляем созданную кнопку в окно.
    // В GTK3 окна обычно могут содержать только один прямой дочерний виджет.
    // gtk_container_add() - это функция для добавления виджетов в контейнеры.
    // GTK_CONTAINER(window) - это приведение типа, позволяющее работать с окном как с контейнером.
    gtk_container_add(GTK_CONTAINER(window), button);

    // Показываем все виджеты, начиная с окна и включая все его дочерние элементы.
    // Виджеты по умолчанию создаются невидимыми; их нужно явно показать, чтобы они появились на экране.
    gtk_widget_show_all(window); // Эта функция покажет и окно, и кнопку внутри него.

    // Запускаем главный цикл обработки событий GTK.
    // Эта функция передает управление библиотеке GTK, которая начинает слушать
    // и обрабатывать все события (клики мыши, нажатия клавиш, системные сообщения и т.д.).
    // Программа будет выполняться в этом цикле до тех пор, пока не будет вызвана
    // gtk_main_quit() (например, при закрытии окна или нажатии нашей кнопки).
    gtk_main();

    // Возвращаем 0, указывая операционной системе на успешное завершение программы.
    return 0;
}
```

-----

## Комментарии к коду и пояснения

Давайте разберём основные строки кода и функции, используемые в примере:

  * `#include <gtk/gtk.h>`: Обязательная строка для всех GTK-приложений. Она включает все необходимые определения и функции для работы с библиотекой.
  * `gtk_init(&argc, &argv);`: **Инициализация GTK**. Это первый вызов, который должен быть сделан в любой GTK-программе. Он обрабатывает любые аргументы командной строки, предназначенные для GTK, и подготавливает внутренние структуры библиотеки.
  * `GtkWidget *window = gtk_window_new(GTK_WINDOW_TOPLEVEL);`: Создаёт новый объект окна верхнего уровня. `GtkWidget` — это базовый тип для всех видимых элементов в GTK.
  * `gtk_window_set_title(GTK_WINDOW(window), "GTK Minimal App");`: Устанавливает текст заголовка окна. `GTK_WINDOW(window)` — это макрос для безопасного приведения общего указателя `GtkWidget*` к более специфичному типу `GtkWindow*`, что необходимо для функций, работающих только с окнами.
  * `gtk_window_set_default_size(GTK_WINDOW(window), 300, 100);`: Задаёт желаемую ширину и высоту окна в пикселях.
  * `gtk_window_set_position(GTK_WINDOW(window), GTK_WIN_POS_CENTER);`: Устанавливает начальное положение окна на экране, в данном случае — по центру.
  * `g_signal_connect(window, "destroy", G_CALLBACK(gtk_main_quit), NULL);`: **Критически важный момент\!** Мы подключаем сигнал "destroy" (который испускается, когда окно закрывается пользователем через "крестик" или Alt+F4) к встроенной функции GTK `gtk_main_quit()`. Эта функция завершает главный цикл событий GTK, позволяя программе корректно завершиться. Если этого не сделать, закрытие окна не остановит программу.
  * `GtkWidget *button = gtk_button_new_with_label("Закрыть");`: Создаёт новую кнопку с текстовой меткой "Закрыть" внутри неё.
  * `g_signal_connect(button, "clicked", G_CALLBACK(on_button_clicked), window);`: Подключаем функцию `on_button_clicked` к сигналу "clicked" от нашей кнопки. Когда пользователь нажимает на кнопку, GTK вызывает `on_button_clicked`. В качестве `user_data` (четвёртый аргумент) мы передаём указатель на наше `window`, чтобы внутри `on_button_clicked` мы знали, какое окно закрывать.
  * `gtk_container_add(GTK_CONTAINER(window), button);`: Добавляет созданную кнопку в окно. В GTK3 большинство контейнеров (включая окна, если они используются как контейнеры для одного виджета) используют `gtk_container_add()`. `GTK_CONTAINER(window)` — это ещё одно приведение типа, позволяющее работать с окном как с контейнером.
  * `gtk_widget_show_all(window);`: Делает окно и все его дочерние элементы (в данном случае, кнопку) видимыми на экране. По умолчанию виджеты создаются невидимыми.
  * `gtk_main();`: **Главный цикл событий GTK**. Эта функция запускает бесконечный цикл, который ждёт событий (кликов, нажатий клавиш, системных сообщений и т.д.) и вызывает соответствующие обработчики. Программа остаётся активной в этом цикле до тех пор, пока не будет вызвана `gtk_main_quit()`, обычно в ответ на сигнал "destroy" окна или клик по нашей кнопке.

-----

## Компиляция и Запуск

Сохраните код в файл с именем `minimal_window.c`.

### Компиляция:

Для сборки используйте следующую команду в терминале, находясь в директории с файлом:

```bash
gcc minimal_window.c -o minimal_window `pkg-config --cflags --libs gtk+-3.0`
```

Обратите внимание, что мы используем `gtk+-3.0` в `pkg-config`, так как наш код написан для GTK3.

### Запуск:

После успешной компиляции вы можете запустить ваше первое GTK-приложение:

```bash
./minimal_window
```

-----

## Ожидаемый результат

  * На вашем рабочем столе откроется новое окно с заголовком "GTK Minimal App".
  * Внутри этого окна будет расположена кнопка с надписью **«Закрыть»**.
  * При нажатии на кнопку **«Закрыть»** (или при закрытии окна стандартным способом, например, через "крестик" в заголовке), программа корректно завершит свою работу, и окно исчезнет.

-----

## Дополнительные ресурсы

  * [**Официальная документация по GTK 3**](https://docs.gtk.org/gtk3/)
  * [**Общая страница для разработчиков GTK**](https://www.google.com/search?q=https://developer.gnome.org/gtk/stable/)
  * [**Репозиторий с примерами кода из этого руководства**](https://github.com/AIDevelopersMonster/C_GUI_Handbook)

-----

### Навигация

  * [Глава 13: Введение в GTK](https://www.google.com/search?q=link_to_chapter13.md)
  * [Глава 15: Добавление нескольких виджетов и компоновка](https://www.google.com/search?q=link_to_chapter15.md)